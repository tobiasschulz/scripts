#!/usr/bin/perl

use strict;
use warnings;

use Term::ANSIColor qw(:constants :pushpop);

sub init {
	    mkdir "/etc/hosts.d";
}

sub rebuild {
	my $hosts = "";

	open my $f, "<", "/etc/hosts";
	my $line;
	while (defined($line = <$f>)) {
		if ($line =~ /^..hosts.d/) {
			last;
		}
		$hosts .= $line;
	}
	close $f;

	$hosts =~ s/\s+$//igm;

	open $f, ">", "/etc/hosts";
	print $f $hosts;
	print $f "\n\n# hosts.d\n";

    my %hosts = hosts();
	for my $host (keys %hosts) {
		my $ip = $hosts{$host};

		print $f "$ip $host $host.local\n";
	}

	close $f;
}

sub list {
    my %hosts = hosts();
    for my $host (sort keys %hosts) {
        my $ip = $hosts{$host};
        print "$ip $host\n";
    }
}

sub padding {
	my ($str, $len1) = @_;
	my $len2 = length($str);
	if ($len2 <= $len1) {
		return " " x ($len1-$len2);
	}
	else {
		return "";
	}
}

sub check {
    my %hosts = hosts();
    for my $host (sort keys %hosts) {
        my $ip = $hosts{$host};
        
        my $ping = ping_ms($ip);
        
        local $Term::ANSIColor::AUTORESET = 1;
        print BLUE "$host";
        print padding($host, 7);
        print " (";
        print YELLOW "$ip";
        print "): ";
        print padding($ip, 15);
        
        if ($ping) {
        	print BOLD GREEN "up";
        	print MAGENTA " ".$ping;
	        print padding($ping, 8);
        }
        else {
        	print BOLD RED "down";
        }
        print " (";
        print join(", ", sort(check_ports($ip)));
        print ")";
        print "\n";
    }
}

sub ping_ms {
	my ($ip) = @_;
	my $line = `ping -c 1 $ip | grep time=`;
	if ($line =~ /time=(.*?)$/) {
		my $ms = $1;
		chomp $ms;
		return $ms;
	}
	else {
		return;
	}
}

sub check_ports {
	my ($ip) = @_;
	my %ports = (
			21 => "ftp", 22 => "ssh", 25 => "smtp", 80 => "http", 143 => "imap", 
			443 => "https", 465 => "smtps", 993 => "imaps",
			25565 => "minecraft", 10011 => "teamspeak",
			5900 => "vnc:0", 5901 => "vnc:1", 5902 => "vnc:2", 5903 => "vnc:3", 5904 => "vnc:4", 5905 => "vnc:5",
	);
	
	my @running = ();
	
	for my $port (keys %ports) {
		my $service = $ports{$port};
		if (`nc -z $ip $port && echo true` =~ /true/) {
			push @running, $service;
		}
	}
	
	return @running;
}

sub hosts {
	my %hosts = ();
    for my $host (split /\s+/, `cd /etc/hosts.d/; ls`) {
        chomp $host;
        open my $h, "<", "/etc/hosts.d/".$host;
        my $ip = <$h>;
        chomp $ip;
        close $h;
        $hosts{$host} = $ip;
    }
    return %hosts;
}

sub add {
	my @arg = @_;

	if (scalar @arg == 2) {
	    my $ip = $arg[0];
	    my $host = $arg[1];
	    $ip =~ s/[^a-zA-Z0-9_.-]//igm;
	    $host =~ s/[^a-zA-Z0-9_.-]//igm;
	    if ($ip =~ /[a-zA-Z]/i) {
	    	($host, $ip) = ($ip, $host);
	    }
	    
	    print "IP: " . $ip . "\n";
	    print "Host: " . $host . "\n";
	    
	    open my $f, ">", "/etc/hosts.d/".$host;
	    print $f $ip."\n";
	    close $f;
	}
	else {
		print STDERR "Syntax: $0 add IP HOST\n";
	}
}

sub sync {
	for my $ip (split /\s+/, `cat /etc/hosts.d/*`) {
		chomp $ip;
		system("rsync -e 'ssh -oStrictHostKeyChecking=no -oBatchMode=yes ' -za $ip:/etc/hosts.d/ /etc/hosts.d/ 2>/dev/null");
		system("rsync -e 'ssh -oStrictHostKeyChecking=no -oBatchMode=yes ' -za /etc/hosts.d/ $ip:/etc/hosts.d/ 2>/dev/null");
	}
}

sub install {
	system("mv /etc/crontab /etc/crontab.bak; grep -v $0 /etc/crontab.bak > /etc/crontab");
	{
		open my $f, ">>", "/etc/crontab";
		print $f '*/5 * * * * root '.$0.' check > /var/run/hosts-availability.new; mv /var/run/hosts-availability.new /var/run/hosts-availability; $(dirname '.$0.')/update-motd'."\n";
		print $f '0 * * * * root '.$0.' sync'."\n";
		close $f;
	}
	unlink("/etc/update-motd.d/10-help-text");
	{
		open my $f, ">", "/etc/update-motd.d/10-hosts";
		print $f q{echo; cat /var/run/hosts-availability | perl -n -e 'print "  "; print;' 2>/dev/null\n};
		close $f;
	}
	system("chmod 0777 /etc/update-motd.d/10-hosts");
	for my $pkg (qw(update-motd netcat-openbsd landscape-common)) {
		system(qq{dpkg -l | grep $pkg >/dev/null 2>&1 || aptitude install $pkg});
	}
}

init;
if (@ARGV && $ARGV[0] eq "add") {
	shift @ARGV;
	add @ARGV;
}
elsif (@ARGV && $ARGV[0] eq "sync") {
	sync;
	rebuild;
}
elsif (@ARGV && $ARGV[0] eq "list") {
	list;
}
elsif (@ARGV && $ARGV[0] eq "check") {
	check;
}
elsif (@ARGV && $ARGV[0] eq "install") {
	install;
}
else {
	rebuild;
}

1;
